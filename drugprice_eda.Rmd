---
title: "Prescription Drug Price EDA"
author: "USAFactsTyler"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    keep_md: TRUE
    toc: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Introduction

This document reflects my exploration of the datasets found at the [CMS Drug Spending](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Information-on-Prescription-Drugs/index.html) site. This document is broken up into three different sections with the following research questions driving each phase of data exploration:

1. What is the relationship between spend and claims at a brand level and has that relationship changed over the past five years?
2. Is there a material difference in the relationships discovered in Research Question 1 between the three programs for which CMS has provided data, namely Medicare Part B, Medicare Part D and Medicaid?
3. Are there sub-categories of prescription drugs that exhibit noticeably higher growth in spend relative to claims? Conversely, are there sub categories of prescription drugs that exhibit noticeably lower growth in spend relative to claims?

## Background Definitions

* Types of drugs covered by Medicare Part B - Medicare Part B covers prescription drugs that are either administered by a medical professional in a patient setting or in various outpatient settings

* Types of drugs covered by Medicare Part D - Medicare Part D covers prescription drugs that can be self-administered and 

* Total Spend Medicare Part B - Drug spending metrics for Part B drugs represent the full value of the product, including the Medicare payment and beneficiary liability. All Part B drug spending metrics are calculated at the Healthcare Common Procedure Coding System (HCPCS) level.

* Total Spend Medicare Part D - Drug spending metrics for Part D drugs are based on the gross drug cost, which represents total spending for the prescription claim, including Medicare, plan, and beneficiary payments. The Part D spending metrics do not reflect any manufacturersâ€™ rebates or other price concessions as CMS is prohibited from publicly disclosing such information.

* Total Spend Medicaid - Drug spending metrics for Medicaid represent the total amount reimbursed by both Medicaid and non-Medicaid entities to pharmacies for the drug. Medicaid drug spending contains both the Federal and State Reimbursement and is inclusive of any applicable dispensing fees. In addition, this total is not reduced or affected by Medicaid rebates paid to the states.

* Total Claims - Number of prescription fills for each drug. Includes original prescriptions and refills. 

## Preliminary Cleaning/Summary

Theree are two things that need to be done with these datasets before we can start exploring them:

1. General data cleaning tasks such as changing variable types to the appropriate values and omitting missing values.
2. Convert the total spend metrics across each of the three programs to be inflation adjusted. Given that we are generally interested in comparing how things have changed over time, I will be using the inflation adjusted spend values as a default.

```{r packageload, include = FALSE}
rm(list=ls(all=T))

library(tidyverse)
library(tidyselect)
library(viridis)
library(ggthemes)
library(ggridges)
library(knitr)
library(kableExtra)
library(scales)
```

```{r dataload, include = FALSE}
medicaid <- read_csv("medicaidsrc.csv")
partb <- read_csv("medicarepartb.csv")
partd <- read_csv("medicarepartd.csv")
medicare_spend <- read_csv("medicare_spend.csv")
inflation <- read_csv("inflation.csv")
```

```{r datacleaning, include = FALSE}
partd <- partd %>%
  mutate_at(c("Brand Name", "Generic Name", "Manufacturer"), as_factor) %>%
  na.omit(.) %>%
  left_join(inflation %>% filter(yeartype == "fiscal", baseyear == 2017), by = c("Year" = "year")) %>%
  mutate(`Inf Total Spend` = signif(`Total Spending` * inf_rate, 3))

colnames(partd)[6] <- "Total Claims"

partb <- partb %>%
  mutate(`Generic Name` = ifelse(is.na(`Generic Name`), "Not Supplied", `Generic Name`)) %>%
  mutate_at(c("Medicare Billing Code (HCPCS Code)", "Brand Name", "Generic Name"), as_factor) %>%
  na.omit(.) %>%
  left_join(inflation %>% filter(yeartype == "fiscal", baseyear == 2017), by = c("Year" = "year")) %>%
  mutate(`Inf Total Spend` = signif(`Total Spending` * inf_rate, 3))

medicaid <- medicaid %>%
  mutate_at(c("Brand Name", "Generic Name", "Manufacturer"), as_factor) %>%
  na.omit(.) %>%
  left_join(inflation %>% filter(yeartype == "fiscal", baseyear == 2017), by = c("Year" = "year")) %>%
  mutate(`Inf Total Spend` = signif(`Total Spending` * inf_rate, 3))

medicaid_bind <- medicaid %>%
  group_by(`Brand Name`, Year, `Generic Name`) %>%
  summarise(`Nom Total Spend` = sum(`Total Spending`), `Inf Total Spend` = sum(`Inf Total Spend`), `Total Claims` = sum(`Total Claims`), Program = "Medicaid", `Total Beneficiaries` = NA)

partb_bind <- partb %>%
  group_by(`Brand Name`, Year, `Generic Name`) %>%
  summarise(`Nom Total Spend` = sum(`Total Spending`), `Inf Total Spend` = sum(`Inf Total Spend`), `Total Claims` = sum(`Total Claims`), Program = "Medicare Part B", `Total Beneficiaries` = sum(`Total Beneficiaries`))

partd_bind <- partd %>%
  group_by(`Brand Name`, Year, `Generic Name`) %>%
  summarise(`Nom Total Spend` = sum(`Total Spending`), `Inf Total Spend` = sum(`Inf Total Spend`), `Total Claims` = sum(`Total Claims`), Program = "Medicare Part D", `Total Beneficiaries` = sum(`Total Beneficiaries`))

combined <- bind_rows(medicaid_bind, partb_bind, partd_bind)
combined$Program <- as_factor(combined$Program)
  

rm(medicaid_bind, partb_bind, partd_bind)

combined <- combined %>%
  ungroup(.) %>%
  mutate(Year = as.numeric(Year)) %>%
  group_by(`Brand Name`, Program) %>%
  arrange(`Brand Name`, Program, Year) %>%
  summarise(numyrs = n_distinct(Year), firstyear = min(Year)) %>%
  ungroup(.) %>%
  right_join(combined, by = c("Brand Name", "Program")) %>%
  group_by(`Brand Name`, Program) %>%
  mutate(Yearnum = as.numeric(Year), 
         complete = ifelse(Yearnum - firstyear + 1 == numyrs, "Complete", "Incomplete"),
         complete = ifelse(any(complete == "Complete"), "Complete", "Incomplete")) %>%
  ungroup(.)

inflation_wide <- inflation %>%
  spread(baseyear, inf_rate) %>%
  rename(baseyear_2017 = `2017`, baseyear_2018 = `2018`)

medicare_spend <- medicare_spend %>%
  gather(Year, Spend, -Program) %>%
  mutate(Year = as.numeric(Year)) %>%
  left_join(inflation_wide, by = c("Year" = "year")) %>%
  mutate(nomspend = Spend/baseyear_2018, infspend = (Spend/baseyear_2018)*baseyear_2017) %>%
  rename(infspend_2018 = Spend, infspend_2017 = infspend)
```

```{r partd_eda_summary}
summary(partd)
```

Looking at the summary for Medicare Part D, there are four things that I want to highlight:

1. The distance between the first two quartiles and the max value is heavily right skewed for each of the "Total" metrics. This likely implies there are some large outliers for each of the univariate distributions
2. There are many more drugs on the market in 2017 than in 2013. The jump between 2016 and 2017 was especially large, at a 27% increase in one year.
3. There top 6 manufacturers supplied 26% of all brands in this time frame, implying the market is characterized by several large players but also consists of many smaller and mid-level firms.
4. The products with the most brand nad manufacturer combinations seem to be diabetic insulin needles.

```{r partb_eda_summary}
summary(partb)
```

Looking at the summary for Medicare Part B, there are three things that I want to highlight:

1. There is no manufacturer level information for this particular dataset
2. The Total metrics are again all heavily right skewed
3. The introduction of drugs over each of the years has been much slower than Medicare Part D.


```{r medicaid_eda_summary}
summary(medicaid)
```

Looking at the summary for Medicaid, there are three things I want to highlight:

1. Surprisingly, there does not appear to be any change in the number of drugs offered between 2016 and 2017. There is still
2. The Total Metrics are again heavily right skewed
3. The medicaid information doesn't contain benificiary information, but does contain manufacturer level data.

# Body

## Aggregate Trends

The first thing that I'm going to look at is what's happening in aggregate across each of the three programs. The only things we can compare across all three programs are the inflation adjusted total spend and total claims at a brand level. There are two features I'm going to extract from this data, which are the following: the first year that each brand was introduced and whether or not a brand was continually offered through 2017. This will allow us to minorly control for the different lifecycle stages that drugs are at in terms of how long they have been on the market (although this is still imperfect given we don't know things like if a brand has patent that is expiring).

### Combined

The first graphic I want to look at is the average spend per claim is across each of the programs. A caveat here is that I'm only going to look at drugs that have been on the market for every year of data included in this dataset because I want to see how this metric is changing over time in and want to account for new drugs influencing that measure of central tendency rather than other forces.

```{r combined_aggregate_trends_1}
# Average spend per claim for medicare part d, medicare part b, and medicaid from 2013-2017 (inflation adjusted), only drugs on market all 5 years 
combined %>%
  filter(numyrs == 5) %>%
  group_by(Program, Year) %>%
  summarise(`Average Spend Per Claim` = sum(`Inf Total Spend`)/sum(`Total Claims`), `Total Claims` = sum(`Total Claims`)) %>%
  ggplot(aes(x = Year, y = `Average Spend Per Claim`, colour = Program)) +
  geom_line(size = 1, aes(group=Program)) +
  labs(y = "Average Spend per Claim", title = "Average spend per claim* for Medicare Part B has grown by\n63 dollars over 5 years in real terms", caption = "*Only examining drugs that have been on market for all 5 years") +
  scale_y_continuous(labels = function(x) paste0("$", x), limits = c(0,600)) +
  scale_color_viridis(option = "E", discrete = TRUE) +
  theme_minimal()
```

The most interesting thing here appears to be the increase in average cost per claim for Medicare Part B, which has increased \$63 dollars in real terms. Medicaid and Medicare Part D both experienced minor bumps between 2013 and 2014 but have since fallen back to the same value they had in 2013.

```{r combined_aggregate_trends_2}
# Percent change from 2013-2017 (inflation adjusted), in average spend per claim for medicare part d, medicare part b, and medicaid, only drugs on market all 5 years
combined %>%
  filter(numyrs == 5) %>%
  group_by(Program, Year) %>%
  summarise(`Average Spend Per Claim` = sum(`Inf Total Spend`)/sum(`Total Claims`)) %>%
  mutate(perchange = `Average Spend Per Claim`/lag(`Average Spend Per Claim`, n = 4) - 1) %>%
  na.omit(.) %>%
  ggplot(aes(x = Program, y = perchange, fill = "foo")) +
  geom_bar(stat = "identity") +
  labs(y = "% Diff in Avg Cost Per Claim", title = "Average spend per claim* for Medicare Part B has grown by\n13.5% over 5 years in real terms", caption = "*Only examining drugs that have been on market for all 5 years") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  scale_fill_manual(values = "#00204DFF") +
  theme_minimal() +
  theme(legend.position = "none") 
```

Looking at the same metric on a percentage change basis from 2013 to 2017, there has been a 13.5% increase of average spend per claim for Medicare Part B. Medicaid is flat, while Medicare Part D shows only a 1.5% increase. All of these percentage changes are in real terms.

```{r combined_aggregate_trends_3}
# Prescription drug spend as % of total medicare part b spend from 2013-2017 (inflation adjusted)
combined %>%
  filter(Program %in% c("Medicare Part B")) %>%
  group_by(Year, Program) %>%
  summarise(totalcost_drugs = sum(`Inf Total Spend`)) %>%
  left_join(select(medicare_spend, Program, Year, infspend_2017), by = c("Program", "Year")) %>%
  mutate(drugsper_total = totalcost_drugs/infspend_2017) %>%
  ggplot(aes(x=Year, y = drugsper_total, color = "foo")) +
  geom_line(size = 1) +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"), limits = c(0,0.1)) +
  scale_color_manual(values = "#00204DFF") +
  labs(y = "Drug Spend as % of Part B", title = "Prescription drug spending* has grown 1 percentage point\nas a portion of all Medicare Part B spend", caption = "*Spend in 2017 inflation adjusted dollars") +
  theme_minimal() +
  theme(legend.position = "none") 
```

As a point of reference, the portion of the total Medicare Part B spend that prescription drugs account for has only increased by about 1%. Even though the average spend per claim for this program has substantially increased over the past five years, the total effect on Medicare Part B's cost is not as significant.

```{r combined_aggregate_trends_4}
# Average claims per beneficiary for medicare part b and part d
combined %>%
  filter(numyrs == 5, Program != "Medicaid") %>%
  group_by(Program, Year) %>%
  summarise(`Average Claims Per Beneficiary` = sum(`Total Claims`)/sum(`Total Beneficiaries`)) %>%
  ggplot(aes(x = Year, y = `Average Claims Per Beneficiary`, colour = Program)) +
  geom_line(size = 1, aes(group=Program)) +
  labs(y = "Average Claims per Beneficiary", title = "Average claims per beneficiary have fallen since 2013\nfor both Medicare programs", caption = "*Only examining drugs that have been on market for all 5 years") +
  scale_color_viridis(option = "E", discrete = TRUE) +
  theme_minimal()
```

Another dynamic that I wanted to understand was the rate at which beneficiaries were making claims over time. Again I was only looking at drugs that have been available for all five years in the dataset as a controlling factor. For Medicare Part D, this rate has consistently declined at a fairly slow rate, while Medicare Part B shows a slightly different trend with a large drop between 2014 and 2015 which has slowly crept up in the two years following. As a baseline, Medicare Part D has a higher rate of claims per beneficiary than Medicare Part B, but I would guess this is due to the expected treatment cycles of the drugs that are covered by each program, as Medicare Part B covers things like vaccinations which are not expected to have a high claims per beneficiary ratio.

```{r combined_aggregate_trends_5}
# top-20 drugs spend percent of total spend by program by year
combined %>%
  group_by(Program, Year) %>%
  summarise(`Program Spend` = sum(`Nom Total Spend`)) %>%
  right_join(combined, by = c("Program","Year")) %>%
  group_by(Program, Year) %>%
  mutate(percent_program = `Nom Total Spend`/`Program Spend`, percent_program_rank = min_rank(desc(percent_program))) %>%
  filter(percent_program_rank <= 20) %>%
  arrange(Program, Year, percent_program_rank) %>%
  summarise(top_20_perspend = sum(percent_program)) %>%
  mutate(rest_perspend = 1 - top_20_perspend, ind = row_number()) %>%
  rename("Top 20 Drugs" = top_20_perspend, "All Other Drugs" = rest_perspend) %>%
  gather(drug_group, ind, -Program, -Year) %>%
  filter(drug_group != "ind") %>%
  rename("Percent" = ind) %>%
  ggplot(aes(x = Year, y = Percent, fill = drug_group)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  scale_fill_viridis(option = "E", discrete = TRUE) +
  facet_grid(. ~ Program) +
  theme_minimal() +
  labs(title = "The top 20 drugs in terms of spend as a percent of total program spend", subtitle = "Medicaid & Medicare Part D drugs have become less concentrated in spend over time") +
  theme(axis.text.x = element_text(angle = 90)) +
  guides(fill = guide_legend(title="Drug Spend Category"))
```

Both Medicaid and Medicare Part D have had the top 20 drugs comprising a smaller portion of the total spend in 2017 relative to 2013. This seems to provide some evidence that the prescription drug markets are not becoming more concentrated over the past five years, but we can look to confirm this later on by looking at full distributions.

```{r combined_aggregate_trends_6}
# Count of drugs introduced each year 2014-2017
combined %>% 
  group_by(Program, firstyear) %>%
  tally() %>%
  filter(firstyear != 2013) %>%
  ggplot(aes(x = firstyear, y = n, fill = Program)) +
  geom_bar(stat = "identity", position = position_dodge2(preserve = "single")) +
  scale_fill_viridis(option = "E", discrete = TRUE) +
  labs(x = "Year", y = "Count of new drugs on market", title = "The number of new drugs that government health programs\nare covering has slowed") +
  theme_minimal()
```

Finally I also wanted to see how many drugs have been introduced in each successive year and it appears that the rate of new drugs that are landing on the market is slowing down, although Medicare Part D had a large increase in 2017. I suspect that over a larger period of time a seasonal component to this might be visible but it's too short to tell for now.

## Univariate Distribution Trends - Brand Level

Before diving deeper into these datasets, there are a few general notes I want to make:

1. I am planning to just examine the subset of drugs that have been consistently avaiable all five years of the dataset.
2. My suspicion (based on the summary quartiles in the introduction) is that all of these variables are close to a lognormal distribution, so I am planning on log-transforming the variables of interest and looking at their distributions then.
3. All spend variables will be examined in terms of inflation adjusted spend.

### Medicare Part D

```{r partd_eda_univariate, include = FALSE, eval = FALSE}
# Just to visually confirm what I was seeing in the quartile summaries in the introduction, I want to look at a ridgeplot of each of the three primary metrics that I'm interested in: Total Spend, Total Claims, and Total Beneficiaries. # Indeed, all of these metrics are heavily right skewed. As such, I want to look at the "total" metrics from a log-transformed univariate perspective across each of the three datasets.
partd %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partd, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  ggplot(aes(x = `Inf Total Spend`, y = Year)) +
  geom_density_ridges() +
  theme_minimal(base_size = 14) + theme(axis.text.y = element_text(vjust = 0)) +
  xlim(0, 1e7)

partd %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partd, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  ggplot(aes(x = `Total Claims`, y = Year)) +
  geom_density_ridges() +
  theme_minimal(base_size = 14) + theme(axis.text.y = element_text(vjust = 0)) +
  xlim(0, 1e5)

partd %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partd, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  ggplot(aes(x = `Total Beneficiaries`, y = Year)) +
  geom_density_ridges() +
  theme_minimal(base_size = 14) + theme(axis.text.y = element_text(vjust = 0)) +
  xlim(0, 1e5)
```

```{r partd_eda_univariate_log_spend}
partd %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partd, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`), 
            brandbens = sum(`Total Beneficiaries`)) %>%
  ungroup(.) %>%
  mutate(logspend = log(brandspend)) %>%
  ggplot(aes(x = logspend, y = as_factor(Year), fill = factor(..quantile..))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "E") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(vjust = 0)) +
  labs(x = "Log of Total Spend", y = "Year", title = "Total Spend of Medicare Part D on prescription drugs\nfor only brands available all five years")
```

Looking at Medicare Part D's log transformed Total Spend variabile by year, it appears that the distribution is becoming more spread out. Quartile 4 appears to be shifting right and the quartile 1 followed until 2015 but began to shift left afterwards. My quick thoughts are that these changes are a result of two separate market forces. First, since we are only looking at drugs that have been available for the past five years, there may be a set of brands that are winding down their product life cycle or have had a patent expire, thereby requiring them to either reduce prices or consumers are substituting to generic competitors. Second, there does appear to be a subset of drugs that are increasing in spend over time, which could be driven by either an increase of claims at a consistent price or a general price increase.

```{r partd_eda_univariate_log_claims}
partd %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partd, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`), 
            brandbens = sum(`Total Beneficiaries`)) %>%
  ungroup(.) %>%
  mutate(logclaims = log(brandclaims)) %>%
  ggplot(aes(x = logclaims, y = as_factor(Year), fill = factor(..quantile..))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "E") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(vjust = 0)) +
  labs(x = "Log of Total Claims", y = "Year", title = "Total Claims of Medicare Part D on prescription drugs\nfor only brands available all five years")
```

Looking at Medicare Part D's log transformed Total Claims variabile by year, it appears that the distribution is starting to become bimodal. Quartile 1 is becoming more dense and has shifted left while quartile 4 has remained relatively constant since 2013 but is showing greater density right around the 75th percentile. As a result, the third quartile has grown in width. This seems to reinforce the notion that the distribution of drugs is representative of two sub-groups.

```{r partd_eda_univariate_log_bens}
partd %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partd, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`), 
            brandbens = sum(`Total Beneficiaries`)) %>%
  ungroup(.) %>%
  mutate(logbens = log(brandbens)) %>%
  ggplot(aes(x = logbens, y = as_factor(Year), fill = factor(..quantile..))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "E") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(vjust = 0)) +
  labs(x = "Log of Total Beneficiaries", y = "Year", title = "Total Beneficiaries of Medicare Part D on prescription drugs\nfor only brands available all five years")
```

Looking at Medicare Part D's log transformed Total Beneficiaries variable by year, the lower half of the distribution appears to be shifting left while the upper half is becoming more spread out. In general, this means that there are more drugs that are serving less individuals.

### Medicare Part B

```{r partb_eda_univariate_log_spend}
partb %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partb, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  mutate(logspend = log(`Inf Total Spend`)) %>%
  ggplot(aes(x = logspend, y = as_factor(Year), fill = factor(..quantile..))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "E") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(vjust = 0)) +
  labs(x = "Log of Total Spend", y = "Year", title = "Total Spend of Medicare Part B on prescription drugs\nfor only brands available all five years")
```

Looking at Medicare Part B's log transformed Total Spend variable, there was a noticeable density consolidation in the second quartile from 2013 to 2016 but in 2017 this trend has somewhat reversed. Relative to 2013, the largest difference between the two distributions is a more even density within the third quartile, implying a number of brands are now more expensive than they were in 2013.

```{r partb_eda_univariate_log_claims}
partb %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partb, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  mutate(logclaims = log(`Total Claims`)) %>%
  ggplot(aes(x = logclaims, y = as_factor(Year), fill = factor(..quantile..))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "E") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(vjust = 0)) +
  labs(x = "Log of Total Claims", y = "Year", title = "Total Claims of Medicare Part B on prescription drugs\nfor only brands available all five years")
```

Looking at Medicare Part B's log transformed Total Claims, it appears that the density of brands around the third and fourth quartile in 2013 has been gradually shifting solidly into the third quartile, while the first and second quartiles have been slightly shifting left. This implies that a number of brands are having fewer claims relative to 2013.

```{r partb_eda_univariate_log_bens}
partb %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partb, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  mutate(logbens = log(`Total Beneficiaries`)) %>%
  ggplot(aes(x = logbens, y = as_factor(Year), fill = factor(..quantile..))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "E") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(vjust = 0)) +
  labs(x = "Log of Total Beneficiaries", y = "Year", title = "Total Beneficiaries of Medicare Part B on prescription drugs\nfor only brands available all five years")
```
Looking at Medicare Part B's log transformed Total Beneficiaries, the fourth quartile appears less dense with a longer tail in 2017 relative to 2013. There also seems to be a greater density appearing on the border between the first and second quartile as the distribution is becoming closer to bimodal. This implies that a number of brands are reaching less beneficiaries in 2017 relative to 2013.

### Medicaid

```{r medicaid_eda_univariate_log_spend}
medicaid %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(medicaid, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`)) %>%
  ungroup(.) %>%
  mutate(logspend = log1p(brandspend)) %>%
  ggplot(aes(x = logspend, y = as_factor(Year), fill = factor(..quantile..))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "E") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(vjust = 0)) +
  labs(x = "Log of Total Spend", y = "Year", title = "Total Spend of Medicaid on prescription drugs\nfor only brands available all five years")

```

Looking at Medicaid's log transformed Total Spend, the distribution is showing an increase of density in the fourth quartile as well as at the median point in 2017 relative to 2013. Additionally the fourth quartile was continually shifting left through 2016 but reversed trend in 2017.

```{r medicaid_eda_univariate_log_claims}
medicaid %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(medicaid, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`)) %>%
  ungroup(.) %>%
  mutate(logclaims = log1p(brandclaims)) %>%
  ggplot(aes(x = logclaims, y = as_factor(Year), fill = factor(..quantile..))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis(discrete = TRUE, name = "Quartiles", option = "E") +
  theme_minimal(base_size = 14) +
  theme(axis.text.y = element_text(vjust = 0)) +
  labs(x = "Log of Total Claims", y = "Year", title = "Total Claims of Medicaid on prescription drugs\nfor only brands available all five years")
```

Looking at Medicaid's log transformed Total Spend, the distribution appears to have a greater density of brands in the first quartile. This implies that there are less brands with a very small amount of claims being made against them. This makes sense as brands have spent more time on the market their exposure grows. It also appears that the distribution is skewing left, implying there is a general trend of brands receiving less claims.

## Bivariate Change - Brand Level

```{r brandchng, include = FALSE}
chngyr <- 2017 - 2013

partd_brandchng <- partd %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partd, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  group_by(`Brand Name`, Year, Category) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`), 
            brandbens = sum(`Total Beneficiaries`),
            avgspendperclaim = brandspend/brandclaims) %>%
  ungroup(.) %>%
  group_by(`Brand Name`, Category) %>%
  arrange(Year, .by_group = TRUE) %>%
  mutate(nomchngspend = brandspend - lag(brandspend, n = chngyr), 
         nomchngdose = branddose - lag(branddose, n = chngyr), 
         nomchngclaims = brandclaims - lag(brandclaims, n = chngyr), 
         nomchngbens = brandbens - lag(brandbens, n = chngyr),
         nomchngspendperclaim = avgspendperclaim - lag(avgspendperclaim, n = chngyr),
         perchngspend = (brandspend-lag(brandspend, n = chngyr))/lag(brandspend, n = chngyr),
         perchngdose = (branddose-lag(branddose, n = chngyr))/lag(branddose, n = chngyr),
         perchngclaims = (brandclaims-lag(brandclaims, n = chngyr))/lag(brandclaims, n = chngyr),
         perchngbens = (brandbens-lag(brandbens, n = chngyr))/lag(brandbens, n = chngyr),
         perchngspendperclaim = (avgspendperclaim - lag(avgspendperclaim, n = chngyr))/lag(avgspendperclaim, n = chngyr)
         ) %>%
  fill(nomchngspend, 
       nomchngdose, 
       nomchngclaims, 
       nomchngbens,
       nomchngspendperclaim,
       perchngspend,
       perchngdose,
       perchngclaims,
       perchngbens,
       perchngspendperclaim,
       .direction = "up") %>%
  left_join(partd %>% select(`Brand Name`, Description), by = "Brand Name") %>%
  distinct()

partb_brandchng <- partb %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(partb, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`), 
            brandbens = sum(`Total Beneficiaries`),
            avgspendperclaim = brandspend/brandclaims) %>%
  ungroup(.) %>%
  group_by(`Brand Name`) %>%
  arrange(Year, .by_group = TRUE) %>%
  mutate(nomchngspend = brandspend - lag(brandspend, n = chngyr), 
         nomchngdose = branddose - lag(branddose, n = chngyr), 
         nomchngclaims = brandclaims - lag(brandclaims, n = chngyr), 
         nomchngbens = brandbens - lag(brandbens, n = chngyr),
         nomchngspendperclaim = avgspendperclaim - lag(avgspendperclaim, n = chngyr),
         perchngspend = (brandspend/lag(brandspend, n = chngyr)) - 1,
         perchngdose = (branddose/lag(branddose, n = chngyr)) - 1,
         perchngclaims = (brandclaims/lag(brandclaims, n = chngyr)) - 1,
         perchngbens = (brandbens/lag(brandbens, n = chngyr)) - 1,
         perchngspendperclaim = (avgspendperclaim - lag(avgspendperclaim, n = chngyr))/lag(avgspendperclaim, n = chngyr)) %>%
  fill(nomchngspend, 
       nomchngdose, 
       nomchngclaims, 
       nomchngbens,
       nomchngspendperclaim,
       perchngspend,
       perchngdose,
       perchngclaims,
       perchngbens,
       perchngspendperclaim,
       .direction = "up") %>%
  left_join(partb %>% select(`Brand Name`, Description), by = "Brand Name") %>%
  distinct()

medicaid_brandchng <- medicaid %>%
  group_by(`Brand Name`) %>%
  summarise(numyrs = n_distinct(Year)) %>%
  ungroup(.) %>%
  right_join(medicaid, by = "Brand Name") %>%
  filter(numyrs == 5) %>%
  group_by(`Brand Name`, Year, Category) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`),
            avgspendperclaim = brandspend/brandclaims) %>%
  ungroup(.) %>%
  group_by(`Brand Name`, Category) %>%
  arrange(Year, .by_group = TRUE) %>%
  mutate(nomchngspend = brandspend - lag(brandspend, n = chngyr), 
         nomchngdose = branddose - lag(branddose, n = chngyr), 
         nomchngclaims = brandclaims - lag(brandclaims, n = chngyr),
         nomchngspendperclaim = avgspendperclaim - lag(avgspendperclaim, n = chngyr),
         perchngspend = (brandspend/lag(brandspend, n = chngyr)) - 1,
         perchngdose = (branddose/lag(branddose, n = chngyr)) - 1,
         perchngclaims = (brandclaims/lag(brandclaims, n = chngyr)) - 1,
         perchngspendperclaim = (avgspendperclaim - lag(avgspendperclaim, n = chngyr))/lag(avgspendperclaim, n = chngyr)) %>%
  fill(nomchngspend, 
       nomchngdose, 
       nomchngclaims,
       nomchngspendperclaim,
       perchngspend,
       perchngdose,
       perchngclaims,
       perchngspendperclaim,
       .direction = "up") %>%
  left_join(medicaid %>% select(`Brand Name`, Description), by = "Brand Name") %>%
  distinct()
```

### Medicare Part D

```{r partd_scatterplots}
partd %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`),
            avgspendperclaim = brandspend/brandclaims) %>%
  ggplot(aes(x = brandspend, y = brandclaims)) +
  geom_point(stat = "identity", alpha = 0.2) +
  facet_wrap(~ as_factor(Year)) +
  scale_x_continuous(trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  scale_y_continuous(trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  labs(x = "Inflation Adj. Spend", y = "Total Claims", title = "Bivariate relationship between Total Spend and Total Claims", subtitle = "Plotted on log scaling") +
  theme_minimal()

partd_brandchng %>%
  select(everything(), -Year, -brandspend, -branddose, -brandclaims, -brandbens) %>%
  distinct() %>%
  ggplot(aes(x = nomchngspend, y = nomchngclaims)) +
  geom_point(stat = "identity", alpha = 0.05) +
  labs(x = "Inflation Adj. Change in Spend", y = "Change in Claims", title = "Bivariate relationship between spend delta and claims delta", subtitle = "Change deltas are between 2013 & 2017") +
  theme_minimal()
```

There are several things to note of the bivariate relationship of spend and claims for Medicare Part D:

1. When plotting spend and claims on a log axis, there is a clear positive linear relationship between the two. This is expected but good to confirm.
2. There are several observations that have either increased dramatically in the number of claims per drug or in the spend per drug, but very rarely both.
3. These graphs together indicate that the drugs could potentially be clustered into several subcategories that each exhibit a single more consistent relationship.

Below are the top 20 drugs in terms of the change from 2013 to 2017 of their average spend per claim. The change in average spend per claim for these drugs is quite large, but many of these drugs serve very niche populations, with only 3 drugs serving over 1000 individuals and none over 3200. 

```{r partd_top_20_spendperclaim}
partd_brandchng %>%
  ungroup(.) %>%
  group_by(`Brand Name`) %>%
  mutate(bens_max = max(`brandbens`)) %>%
  select(`Brand Name`, nomchngspendperclaim, perchngspendperclaim, Description, bens_max) %>%
  distinct() %>%
  arrange(desc(nomchngspendperclaim)) %>%
  ungroup(.) %>%
  top_n(20, wt = nomchngspendperclaim) %>%
  mutate(Rank = row_number(), 
         perchngspendperclaim = paste0(round(perchngspendperclaim*100, 2), "%"), 
         nomchngspendperclaim = ifelse(nomchngspendperclaim < 0, 
                                       paste0("($", abs(round(nomchngspendperclaim, 2)), ")"),
                                       paste0("$", round(nomchngspendperclaim, 2))
                                       )
         ) %>%
  rename("Nominal Average Spend per Claim Delta" = nomchngspendperclaim, "Percentage Average Spend per Claim Delta" = perchngspendperclaim, "Maximum Beneficiaries Between 2013-2017" = bens_max) %>%
  select(Rank, `Brand Name`, `Nominal Average Spend per Claim Delta`, `Percentage Average Spend per Claim Delta`, `Maximum Beneficiaries Between 2013-2017`, Description) %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  scroll_box(width = "100%", height = "600px")
```

Below are the top 20 drugs in terms of the cumulative amount of claims between 2013 to 2017. Of note, there are only two brands that had their average spend per claim increase in that time period, and both of these drugs had a real change of less than \$10.

```{r partd_top_20_totalclaims}
partd_brandchng %>%
  ungroup(.) %>%
  group_by(`Brand Name`) %>%
  mutate(claims_time = sum(`brandclaims`)) %>%
  select(`Brand Name`, nomchngspendperclaim, perchngspendperclaim, claims_time, Description) %>%
  distinct() %>%
  arrange(desc(claims_time)) %>%
  ungroup(.) %>%
  top_n(20, wt = claims_time) %>%
  mutate(Rank = row_number(), 
         perchngspendperclaim = paste0(round(perchngspendperclaim*100, 2), "%"), 
         nomchngspendperclaim = ifelse(nomchngspendperclaim < 0, 
                                       paste0("($", abs(round(nomchngspendperclaim, 2)), ")"),
                                       paste0("$", round(nomchngspendperclaim, 2))
                                       )
         ) %>%
  rename("Nominal Average Spend per Claim Delta" = nomchngspendperclaim, "Percentage Average Spend per Claim Delta" = perchngspendperclaim, "Combined Claims 2013-2017" = claims_time) %>%
  select(Rank, `Brand Name`, `Nominal Average Spend per Claim Delta`, `Percentage Average Spend per Claim Delta`, `Combined Claims 2013-2017`, Description) %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  scroll_box(width = "100%", height = "600px")
```

### Medicare Part B

```{r partb_scatterplots}
partb %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`),
            avgspendperclaim = brandspend/brandclaims) %>%
  ggplot(aes(x = brandspend, y = brandclaims)) +
  geom_point(stat = "identity", alpha = 0.2) +
  facet_wrap(~ as_factor(Year)) +
  scale_x_continuous(trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  scale_y_continuous(trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  labs(x = "Inflation Adj. Spend", y = "Total Claims", title = "Bivariate relationship between Total Spend and Total Claims", subtitle = "Plotted on log scaling") +
  theme_minimal()

partb_brandchng %>%
  select(everything(), -Year, -brandspend, -branddose, -brandclaims, -brandbens) %>%
  distinct() %>%
  ggplot(aes(x = nomchngspend, y = nomchngclaims)) +
  geom_point(stat = "identity", alpha = 0.05) +
  labs(x = "Inflation Adj. Change in Spend", y = "Change in Claims", title = "Bivariate relationship between spend delta and claims delta", subtitle = "Change deltas are between 2013 & 2017") +
  theme_minimal()
```

There are several things to note of the bivariate relationship of spend and claims for Medicare Part B:

1. When plotting spend and claims on a log axis, there still appears to be a somewhat positive linear relationship, but this relationship seems much less consistent than Medicare Part D. However, it's also important to note that there are also far fewer drugs that are offered under Medicare Part B relative to both Part D and Medicaid, and thus this variance could just be resulting from fewer observations.
2. Again, unlike Medicare Part D, there are not as many drugs that have increased as dramatically in claims while remaining relatively constant in spend. There are however still a number of drugs that dramatically increased in spend without much variation in claims. 
3. Overall this helps explain why the average cost per claim in aggregate for Medicare Part B has been increasing. 

Below are the top 20 drugs in terms of the change from 2013 to 2017 of their average spend per claim. Similar to Medicare Part D, the change in average spend per claim for these drugs is quite large, but drug number 20, Orencia*, did have a more substantial reach, serving over 20k beneficiaries in one year between 2013 and 2017. 

```{r partb_top_20_spendperclaim}
partb_brandchng %>%
  ungroup(.) %>%
  group_by(`Brand Name`) %>%
  mutate(bens_max = max(`brandbens`)) %>%
  select(`Brand Name`, nomchngspendperclaim, perchngspendperclaim, Description, bens_max) %>%
  distinct() %>%
  arrange(desc(nomchngspendperclaim)) %>%
  ungroup(.) %>%
  top_n(20, wt = nomchngspendperclaim) %>%
  mutate(Rank = row_number(), 
         perchngspendperclaim = paste0(round(perchngspendperclaim*100, 2), "%"), 
         nomchngspendperclaim = ifelse(nomchngspendperclaim < 0, 
                                       paste0("($", abs(round(nomchngspendperclaim, 2)), ")"),
                                       paste0("$", round(nomchngspendperclaim, 2))
                                       )
         ) %>%
  rename("Nominal Average Spend per Claim Delta" = nomchngspendperclaim, "Percentage Average Spend per Claim Delta" = perchngspendperclaim, "Maximum Beneficiaries Between 2013-2017" = bens_max) %>%
  select(Rank, `Brand Name`, `Nominal Average Spend per Claim Delta`, `Percentage Average Spend per Claim Delta`, `Maximum Beneficiaries Between 2013-2017`, Description) %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  scroll_box(width = "100%", height = "600px")
```

Below are the top 20 drugs in terms of the cumulative amount of claims between 2013 to 2017. Again in contrast to Medicare Part D, half of the top 20 most claimed had their average spend per claim increase in that time period, with the second most claimed drug (Prevnar 13) having its average spend per claim increase by \$35.27 in real terms.

```{r partb_top_20_totalclaims}
partb_brandchng %>%
  ungroup(.) %>%
  group_by(`Brand Name`) %>%
  mutate(claims_time = sum(`brandclaims`)) %>%
  select(`Brand Name`, nomchngspendperclaim, perchngspendperclaim, claims_time, Description) %>%
  distinct() %>%
  arrange(desc(claims_time)) %>%
  ungroup(.) %>%
  top_n(20, wt = claims_time) %>%
  mutate(Rank = row_number(), 
         perchngspendperclaim = paste0(round(perchngspendperclaim*100, 2), "%"), 
         nomchngspendperclaim = ifelse(nomchngspendperclaim < 0, 
                                       paste0("($", abs(round(nomchngspendperclaim, 2)), ")"),
                                       paste0("$", round(nomchngspendperclaim, 2))
                                       )
         ) %>%
  rename("Nominal Average Spend per Claim Delta" = nomchngspendperclaim, "Percentage Average Spend per Claim Delta" = perchngspendperclaim, "Combined Claims 2013-2017" = claims_time) %>%
  select(Rank, `Brand Name`, `Nominal Average Spend per Claim Delta`, `Percentage Average Spend per Claim Delta`, `Combined Claims 2013-2017`, Description) %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  scroll_box(width = "100%", height = "600px")
```

### Medicaid

```{r medicaid_change}
medicaid %>%
  group_by(`Brand Name`, Year) %>%
  summarise(brandspend = sum(`Inf Total Spend`), 
            branddose = sum(`Total Dosage Units`), 
            brandclaims = sum(`Total Claims`),
            avgspendperclaim = brandspend/brandclaims) %>%
  filter(brandspend >= 1) %>%
  ggplot(aes(x = brandspend, y = brandclaims)) +
  geom_point(stat = "identity", alpha = 0.2) +
  facet_wrap(~ as_factor(Year)) +
  scale_x_continuous(trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  scale_y_continuous(trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  labs(x = "Inflation Adj. Spend", y = "Total Claims", title = "Bivariate relationship between Total Spend and Total Claims", subtitle = "Plotted on log scaling") +
  theme_minimal()

medicaid_brandchng %>%
  select(everything(), -Year, -brandspend, -branddose, -brandclaims) %>%
  distinct() %>%
  ggplot(aes(x = nomchngspend, y = nomchngclaims)) +
  geom_point(stat = "identity", alpha = 0.05) +
  labs(x = "Inflation Adj. Change in Spend", y = "Change in Claims", title = "Bivariate relationship between spend delta and claims delta", subtitle = "Change deltas are between 2013 & 2017") +
  theme_minimal()
```


There are two things to note of the bivariate relationship of spend and claims for Medicaid:

1. When plotting spend and claims on a log axis, there appears to be a stronger linear relationship that more closely resembles the relationship exhibited in Medicare Part D.
2. Medicaid spending and claims in general looks more similar to Medicare Part D than it does Part B. Again there seems to be two distinct clusters of drugs that are either have increased heavily in claims but not spend or vice versa but have not increased in both.

Below are the top 20 drugs in terms of the change from 2013 to 2017 of their average spend per claim. The Medicaid dataset didn't provide beneficiary information, so I'm looking at the maximum claims in a given year as a proxy measure of reach instead. Similar to Medicare Part D, the change in average spend per claim for these drugs is again quite large, but most of these drugs also have had a small reach. 

```{r medicaid_top_20_spendperclaim}
medicaid_brandchng %>%
  ungroup(.) %>%
  group_by(`Brand Name`) %>%
  mutate(claims_max = max(`brandclaims`)) %>%
  select(`Brand Name`, nomchngspendperclaim, perchngspendperclaim, Description, claims_max) %>%
  distinct() %>%
  arrange(desc(nomchngspendperclaim)) %>%
  ungroup(.) %>%
  top_n(20, wt = nomchngspendperclaim) %>%
  mutate(Rank = row_number(), 
         perchngspendperclaim = paste0(round(perchngspendperclaim*100, 2), "%"), 
         nomchngspendperclaim = ifelse(nomchngspendperclaim < 0, 
                                       paste0("($", abs(round(nomchngspendperclaim, 2)), ")"),
                                       paste0("$", round(nomchngspendperclaim, 2))
                                       )
         ) %>%
  rename("Nominal Average Spend per Claim Delta" = nomchngspendperclaim, "Percentage Average Spend per Claim Delta" = perchngspendperclaim, "Maximum Claims Between 2013-2017" = claims_max) %>%
  select(Rank, `Brand Name`, `Nominal Average Spend per Claim Delta`, `Percentage Average Spend per Claim Delta`, `Maximum Claims Between 2013-2017`, Description) %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  scroll_box(width = "100%", height = "600px")
```

Below are the top 20 drugs in terms of the cumulative amount of claims between 2013 to 2017. More similar to Medicare Part D, only 4 of the top 20 most claimed had their average spend per claim increase in that time period, with the eighteenth most claimed drug (Proair HFA) showing the largest increase in average spend per claim, at \$11.45 in real terms.

```{r medicaid_top_20_totalclaims}
medicaid_brandchng %>%
  ungroup(.) %>%
  group_by(`Brand Name`) %>%
  mutate(claims_time = sum(`brandclaims`)) %>%
  select(`Brand Name`, nomchngspendperclaim, perchngspendperclaim, claims_time, Description) %>%
  distinct() %>%
  arrange(desc(claims_time)) %>%
  ungroup(.) %>%
  top_n(20, wt = claims_time) %>%
  mutate(Rank = row_number(), 
         perchngspendperclaim = paste0(round(perchngspendperclaim*100, 2), "%"), 
         nomchngspendperclaim = ifelse(nomchngspendperclaim < 0, 
                                       paste0("($", abs(round(nomchngspendperclaim, 2)), ")"),
                                       paste0("$", round(nomchngspendperclaim, 2))
                                       )
         ) %>%
  rename("Nominal Average Spend per Claim Delta" = nomchngspendperclaim, "Percentage Average Spend per Claim Delta" = perchngspendperclaim, "Combined Claims 2013-2017" = claims_time) %>%
  select(Rank, `Brand Name`, `Nominal Average Spend per Claim Delta`, `Percentage Average Spend per Claim Delta`, `Combined Claims 2013-2017`, Description) %>%
  kable(format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  scroll_box(width = "100%", height = "600px")
```


```{r partd_manufacturer, include = FALSE, eval = FALSE}
#TODO Manufacturer Level

partd_manufac <- partd %>%
  group_by(`Brand Name`, Year, Category) %>%
  mutate(avg_spend_per_claim_brand = signif(sum(`Inf Total Spend`)/sum(`Total Claims`), 3)) %>%
  group_by(Manufacturer, add = TRUE) %>%
  mutate(avg_spend_per_claim_manufac = sum(`Inf Total Spend`)/sum(`Total Claims`)) %>%
  mutate(avg_spend_per_claim_resid = signif(avg_spend_per_claim_manufac, 3) - signif(avg_spend_per_claim_brand, 3), 
         avg_spend_per_claim_status = ifelse(avg_spend_per_claim_resid == 0, "at_average", ifelse(avg_spend_per_claim_resid < 0, "below_average", "above_average")), 
         market_diff = avg_spend_per_claim_resid * `Total Claims`) %>%
  ungroup(.) %>%
  group_by(Manufacturer, Year, avg_spend_per_claim_status) %>%
  summarise(manufacturer_diff = sum(market_diff), price_status_drugs = n()) 

```

```{r medicaid_manufacturer, include = FALSE, eval = FALSE}
#TODO Manufacturer Level
medicaid_manufac <- medicaid %>%
  group_by(`Brand Name`, Year, Category) %>%
  mutate(avg_spend_per_claim_brand = signif(sum(`Inf Total Spend`)/sum(`Total Claims`), 3)) %>%
  group_by(Manufacturer, add = TRUE) %>%
  mutate(avg_spend_per_claim_manufac = sum(`Inf Total Spend`)/sum(`Total Claims`)) %>%
  mutate(avg_spend_per_claim_resid = signif(avg_spend_per_claim_manufac, 3) - signif(avg_spend_per_claim_brand, 3), 
         avg_spend_per_claim_status = ifelse(avg_spend_per_claim_resid == 0, "at_average", ifelse(avg_spend_per_claim_resid < 0, "below_average", "above_average")), 
         market_diff = avg_spend_per_claim_resid * `Total Claims`) %>%
  ungroup(.) %>%
  group_by(Manufacturer, Year, avg_spend_per_claim_status) %>%
  summarise(manufacturer_diff = sum(market_diff), price_status_drugs = n()) 
```

## Insulin

Inspired by some of the news coverage over the past six months, I wanted to validate whether Insulin products have been becoming more expensive. Indeed, average spend per claim on Insulin related drugs in Medicare Part D has risen $220.02 since 2013.

```{r partd_insulin}
partd %>% 
  filter(str_detect(`Generic Name`, "Insulin")) %>%
  group_by(Year) %>%
  summarise(totalspend = sum(`Inf Total Spend`), totalclaims = sum(`Total Claims`)) %>%
  mutate(`Average Spend Per Claim` = totalspend/totalclaims) %>%
  ggplot(aes(x=Year, y = `Average Spend Per Claim`, color = "foo")) +
  geom_line(size = 1) +
  scale_y_continuous(labels = function(x) paste0("$", x), limits = c(0,550)) +
  scale_color_manual(values = "#00204DFF") +
  labs(y = "Average Spend Per Claim", title = "Average Spend Per Claim in Medicare Part D on Insulin related drugs\nhas grown by 78%, or $220") +
  theme_minimal() +
  theme(legend.position = "none") 
```

```{r}

partd %>%
  select(`Brand Name`, Year, Category) %>%
  distinct() %>%
  group_by(Category) %>%
  summarise(num_drugs = n_distinct(`Brand Name`))

```

# Open Areas of Inquiry

1. Is there a trend that can be indentified among manufacturers across the various drugs that they produce?
2. Beyond Insulin, are there certain categories of drugs that are changing more dramatically than others?

```{r writecsv_1, include = FALSE, eval = FALSE}
partd_brandlvl <- partd %>%
  group_by(`Brand Name`, Year, `Generic Name`, Category) %>%
  summarise(num_manufac = n_distinct(Manufacturer),
            `Inf Total Spend` = sum(`Inf Total Spend`),
            `Total Spending` = sum(`Total Spending`),
            `Total Dosage Units` = sum(`Total Dosage Units`),
            `Total Claims` = sum(`Total Claims`),
            `Total Beneficiaries` = sum(`Total Beneficiaries`))

medicaid_brandlvl <- medicaid %>%
  group_by(`Brand Name`, Year, `Generic Name`, Category) %>%
  summarise(num_manufac = n_distinct(Manufacturer),
            `Inf Total Spend` = sum(`Inf Total Spend`),
            `Total Spending` = sum(`Total Spending`),
            `Total Dosage Units` = sum(`Total Dosage Units`),
            `Total Claims` = sum(`Total Claims`))
```

```{r writecsv_2, include = FALSE, eval = FALSE}
rm(inflation, chngyr)

files <- mget(ls())

files %>%
  names(.) %>%
  map(~ write_csv(files[[.]], path = paste0("./datacuts/",., ".csv"), append = FALSE))
```
